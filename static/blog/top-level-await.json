{"title":"Top level Await is AWESOME!! <img class=\"emoji\" draggable=\"false\" alt=\"😍\" src=\"https://twemoji.maxcdn.com/v/13.0.1/svg/1f60d.svg\"/>","description":"Top level await is literally the GOAT (Greatest of All Time). In every way. Read on to know why, how to use it, and its implications","date":"28 Dec, 2020 8:51 AM","cover_image":"media/top-level-await-top-of-the-world.jpg","body":"<p><img src=\"\" alt=\"\" class=\"feature-image\" style=\"display: none;\"></p><div class=\"picture-container\">\n  <figure style=\"width: 100%;padding-top: 61.458333333333336%;background-color: rgb(141, 172, 200)\">\n    <picture>\n      <source type=\"image/webp\" media=\"(min-width: 501px)\" data-srcset=\"media/top-level-await-top-of-the-world/large.webp\">\n      <source type=\"image/webp\" media=\"(max-width: 500px)\" data-srcset=\"media/top-level-await-top-of-the-world/small.webp\">\n      <source type=\"image/jpg\" media=\"(min-width: 501px)\" data-srcset=\"media/top-level-await-top-of-the-world/large.jpg\">\n      <source type=\"image/jpg\" media=\"(max-width: 500px)\" data-srcset=\"media/top-level-await-top-of-the-world/small.jpg\">\n      <img alt=\"Placeholder\" data-src=\"media/top-level-await-top-of-the-world/large.jpg\" class=\"lazyload blog-img\">\n    </picture>\n  </figure>\n  </div><p></p>\n<p><mark>Top Level Await</mark> is literally awesome. It's the GOAT!!(<strong>G</strong>reatest <strong>o</strong>f <strong>A</strong>ll <strong>T</strong>ime, in case you couldn't guess <img class=\"emoji\" draggable=\"false\" alt=\"😉\" src=\"https://twemoji.maxcdn.com/v/13.0.1/svg/1f609.svg\">)</p>\n<h1 id=\"The-Dark-Times...\"><a class=\"heading-link\" href=\"blog/top-level-await#The-Dark-Times...\">#</a>The Dark Times...</h1>\n<p>There was an era, where if you tried to pull a stunt like this <img class=\"emoji\" draggable=\"false\" alt=\"👇\" src=\"https://twemoji.maxcdn.com/v/13.0.1/svg/1f447.svg\"> at the top level(i.e. not in any <code>async</code> function),</p>\n<pre><code class=\"language-js\"><span class=\"hljs-title\">const</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">data</span> = await fetch(<span class=\"hljs-type\">URL</span>);</span>\n</code></pre>\n<p>JS would scream at you <img class=\"emoji\" draggable=\"false\" alt=\"👉\" src=\"https://twemoji.maxcdn.com/v/13.0.1/svg/1f449.svg\"> <code>SyntaxError: await is only valid in async function</code></p>\n<p>It was super frustrating. But what could you do then?</p>\n<h2 id=\"The-Hack\"><a class=\"heading-link\" href=\"blog/top-level-await#The-Hack\">#</a>The Hack</h2>\n<p><strong>Wrap it in IIFE</strong></p>\n<blockquote>\n<p><mark>IIFE</mark>: Immediately Invoked Function expressions. <a href=\"https://flaviocopes.com/javascript-iife/\" target=\"_blank\" rel=\"noopener\">Flavio Copes has a really good article about it.</a></p>\n</blockquote>\n<pre><code class=\"language-js\">(<span class=\"hljs-name\">async</span> () =&gt; {\n  const data = await fetch(<span class=\"hljs-name\">URL</span>)<span class=\"hljs-comment\">;</span>\n})()<span class=\"hljs-comment\">;</span>\n</code></pre>\n<blockquote>\n<p>Not really a hack as far as official spec is concerned, but to the code author, it definitely feels like one.</p>\n</blockquote>\n<p>Just look at the code. So many brackets, so much boilerplate. The last line with <code>})();</code> makes me nauseous even after 5 years of JS development. So many weird brackets!!</p>\n<p>But wait, it gets even better <img class=\"emoji\" draggable=\"false\" alt=\"😑\" src=\"https://twemoji.maxcdn.com/v/13.0.1/svg/1f611.svg\"></p>\n<pre><code class=\"language-js\">(<span class=\"hljs-keyword\">async</span> () =&gt; {\n  <span class=\"hljs-keyword\">const</span> response = <span class=\"hljs-keyword\">await</span> fetch(URL);\n  <span class=\"hljs-keyword\">const</span> jsonData = <span class=\"hljs-keyword\">await</span> response.json();\n\n  <span class=\"hljs-keyword\">const</span> finalData = <span class=\"hljs-keyword\">await</span> processJsonData(jsonData);\n\n  <span class=\"hljs-keyword\">if</span> (finalData.propA.propB === <span class=\"hljs-string\">'who-cares'</span>) {\n    <span class=\"hljs-comment\">// Do stuff</span>\n  }\n})();\n</code></pre>\n<p>This code gets messier. And that code above is still very clean. Wait till you try to create your version of MacOS Desktop for Web (Shameless Plug! I'm working on it <img class=\"emoji\" draggable=\"false\" alt=\"😁\" src=\"https://twemoji.maxcdn.com/v/13.0.1/svg/1f601.svg\"> <a href=\"https://macos.now.sh\" target=\"_blank\" rel=\"noopener\">macos.now.sh</a>). It's gonna get outright ugly, and you don't want ugly code. Nobody wants ugly code.</p>\n<h1 id=\"A-New-Hope\"><a class=\"heading-link\" href=\"blog/top-level-await#A-New-Hope\">#</a>A New Hope</h1>\n<blockquote>\n<p>If you're wondering why I'm using Star Wars related words a lot, Mandalorian episode 16 dropped a few days ago, and literally, ************** appeared <img class=\"emoji\" draggable=\"false\" alt=\"😭\" src=\"https://twemoji.maxcdn.com/v/13.0.1/svg/1f62d.svg\">. I'm still shaking from how good that episode was.</p>\n</blockquote>\n<p>In comes Top Level await, <s>slashing droids with his lightsaber</s>, taking the pains of IIFE hacks away.</p>\n<p>Using it is as simple as the first code snippet on top:</p>\n<pre><code class=\"language-js\"><span class=\"hljs-title\">const</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">data</span> = await fetch(<span class=\"hljs-type\">URL</span>);</span>\n</code></pre>\n<p>And it will work perfectly.</p>\n<p>And that second snippet, see this <img class=\"emoji\" draggable=\"false\" alt=\"👇\" src=\"https://twemoji.maxcdn.com/v/13.0.1/svg/1f447.svg\"></p>\n<pre><code class=\"language-js\"><span class=\"hljs-keyword\">const</span> response = <span class=\"hljs-function\">await <span class=\"hljs-title\">fetch</span><span class=\"hljs-params\">(URL)</span></span>;\n<span class=\"hljs-keyword\">const</span> jsonData = <span class=\"hljs-function\">await response.<span class=\"hljs-title\">json</span><span class=\"hljs-params\">()</span></span>;\n\n<span class=\"hljs-keyword\">const</span> finalData = <span class=\"hljs-function\">await <span class=\"hljs-title\">processJsonData</span><span class=\"hljs-params\">(jsonData)</span></span>;\n\n<span class=\"hljs-keyword\">if</span> (finalData.propA.propB === <span class=\"hljs-string\">'who-cares'</span>) {\n  <span class=\"hljs-comment\">// Do stuff</span>\n}\n</code></pre>\n<p>Perfection <img class=\"emoji\" draggable=\"false\" alt=\"👌\" src=\"https://twemoji.maxcdn.com/v/13.0.1/svg/1f44c.svg\">.</p>\n<p>But, there are certain requirements to use it.</p>\n<h1 id=\"Requirements\"><a class=\"heading-link\" href=\"blog/top-level-await#Requirements\">#</a>Requirements</h1>\n<p>It can be used only in <mark>ES Modules</mark>.</p>\n<p>That is, in scripts that are marked as modules in your HTML or in your package.json in Node</p>\n<h2 id=\"Browser\"><a class=\"heading-link\" href=\"blog/top-level-await#Browser\">#</a>Browser</h2>\n<p>In browser, JS alone is nothing. It needs to be linked to by the HTML file.</p>\n<p>In your <code>index.html</code>:</p>\n<pre><code class=\"language-html\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"module\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"index.js\"</span> /&gt;</span>\n</code></pre>\n<p><code>type=\"module\"</code> is necessary for it to be interpreted as an ES Module</p>\n<h2 id=\"NodeJS\"><a class=\"heading-link\" href=\"blog/top-level-await#NodeJS\">#</a>NodeJS</h2>\n<p>You need to have minimum of Node <strong>14.8.0</strong> for this feature to work. Modules were available in 13.9.0, but the top level await was unlocked at 14.8.0 only. The current LTS is v14.15, and I recommend most users to always choose the LTS version. If you're reading this in 2025, and the LTS is v24, go for it, not 14.15. (I hope Node survives that long, what with <a href=\"https://deno.land/\" target=\"_blank\" rel=\"noopener\">Deno</a> and <a href=\"https://github.com/elsaland/elsa\" target=\"_blank\" rel=\"noopener\">Elsa</a> being there now <img class=\"emoji\" draggable=\"false\" alt=\"😅\" src=\"https://twemoji.maxcdn.com/v/13.0.1/svg/1f605.svg\">)</p>\n<blockquote>\n<p>Note: I'm aware that you could use ES Modules long before 13.9.0 in NodeJS, but you had to pass the flag <code>--experimental-module</code>, as in <code>node index.js --experimental-module</code>, and these modules were highly experimental and unstable and subject to change then, so I didn't even bother with them.</p>\n</blockquote>\n<p>These below are some steps to get ES Modules in Node working. Note that these aren't the only methods for that. There are total of 2 or 3 right now, but I will explore the most common one only.</p>\n<h3 id=\"Step-0\"><a class=\"heading-link\" href=\"blog/top-level-await#Step-0\">#</a>Step 0</h3>\n<p>Have npm installed. If you already have node installed, you need not worry, you already have it.</p>\n<p>Check Node version:</p>\n<pre><code class=\"language-bash\"><span class=\"hljs-keyword\">node</span> <span class=\"hljs-title\">-v</span>\n</code></pre>\n<p>Check npm version:</p>\n<pre><code class=\"language-bash\"><span class=\"hljs-built_in\">npm</span> -v\n</code></pre>\n<p>npm should be higher than <code>6.14.8</code> at this point of time.</p>\n<p>But the Linux users might have some issues, as running <code>sudo apt install nodejs</code> downloads a super-old version of Node, and even without npm, that is (The Blasphemy <img class=\"emoji\" draggable=\"false\" alt=\"😤\" src=\"https://twemoji.maxcdn.com/v/13.0.1/svg/1f624.svg\">).</p>\n<p>In that case i recommend you to install nodeJS and npm using this <a href=\"https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-ubuntu-18-04\" target=\"_blank\" rel=\"noopener\">very good article</a>.</p>\n<p>But beware, your problems won't be over because of the permissions issues. I recommend you to install <code>nvm</code> (Nope I didn't misspell <code>npm</code>), which will take care of all these problems for you. <a href=\"https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-ubuntu-18-04\" target=\"_blank\" rel=\"noopener\">Read how to install nvm</a>.</p>\n<p>After you have installed nvm, Run <code>nvm install --lts</code> to install the latest LTS version.</p>\n<p>It's slightly longer method, but much less painful, both in short and long term</p>\n<h3 id=\"Step-1\"><a class=\"heading-link\" href=\"blog/top-level-await#Step-1\">#</a>Step 1</h3>\n<p>Create <code>package.json</code></p>\n<p>Most Node projects will already have the <code>package.json</code> ready, but in case you don't, make one. It's as simple as typing this command:</p>\n<pre><code class=\"language-bash\"><span class=\"hljs-built_in\">npm</span> init -y\n</code></pre>\n<p>This should output a file of this format. Values may be different, but format stays the same:</p>\n<pre><code class=\"language-json\">{\n  <span class=\"hljs-attr\">\"name\"</span>: <span class=\"hljs-string\">\"snippets\"</span>,\n  <span class=\"hljs-attr\">\"version\"</span>: <span class=\"hljs-string\">\"1.0.0\"</span>,\n  <span class=\"hljs-attr\">\"description\"</span>: <span class=\"hljs-string\">\"\"</span>,\n  <span class=\"hljs-attr\">\"main\"</span>: <span class=\"hljs-string\">\"promise-arr.js\"</span>,\n  <span class=\"hljs-attr\">\"scripts\"</span>: {\n    <span class=\"hljs-attr\">\"test\"</span>: <span class=\"hljs-string\">\"echo \\\"Error: no test specified\\\" &amp;&amp; exit 1\"</span>\n  },\n  <span class=\"hljs-attr\">\"keywords\"</span>: [],\n  <span class=\"hljs-attr\">\"author\"</span>: <span class=\"hljs-string\">\"\"</span>,\n  <span class=\"hljs-attr\">\"license\"</span>: <span class=\"hljs-string\">\"ISC\"</span>\n}\n</code></pre>\n<h3 id=\"Step-2\"><a class=\"heading-link\" href=\"blog/top-level-await#Step-2\">#</a>Step 2</h3>\n<p>Add <code>\"type\": module\"</code> in the JSON file. Like this:</p>\n<pre><code class=\"language-diff\">{\n  <span class=\"hljs-string\">\"name\"</span>: <span class=\"hljs-string\">\"snippets\"</span>,\n  <span class=\"hljs-string\">\"version\"</span>: <span class=\"hljs-string\">\"1.0.0\"</span>,\n  <span class=\"hljs-string\">\"description\"</span>: <span class=\"hljs-string\">\"\"</span>,\n  <span class=\"hljs-string\">\"main\"</span>: <span class=\"hljs-string\">\"promise-arr.js\"</span>,\n+ <span class=\"hljs-string\">\"type\"</span>: <span class=\"hljs-string\">\"module\"</span>,\n  <span class=\"hljs-string\">\"scripts\"</span>: {\n    <span class=\"hljs-string\">\"test\"</span>: <span class=\"hljs-string\">\"echo \\\"</span><span class=\"hljs-keyword\">Error</span>: <span class=\"hljs-keyword\">no</span> <span class=\"hljs-keyword\">test</span> specified\\<span class=\"hljs-string\">\" &amp;&amp; exit 1\"</span>\n  },\n  <span class=\"hljs-string\">\"keywords\"</span>: [],\n  <span class=\"hljs-string\">\"author\"</span>: <span class=\"hljs-string\">\"\"</span>,\n  <span class=\"hljs-string\">\"license\"</span>: <span class=\"hljs-string\">\"ISC\"</span>\n}\n</code></pre>\n<p>And you're good to go!</p>\n<h1 id=\"Use-Cases\"><a class=\"heading-link\" href=\"blog/top-level-await#Use-Cases\">#</a>Use Cases</h1>\n<p>Here are some common use cases for top level await:</p>\n<blockquote>\n<p>Note: These use cases are quite simple, and will be most probably composed inside functions, where you can already use <code>async</code>. The most use of top level await would be to consume these higher order functions in the main code.</p>\n</blockquote>\n<h2 id=\"Timer\"><a class=\"heading-link\" href=\"blog/top-level-await#Timer\">#</a>Timer</h2>\n<p>Whenever I jump onto any project, I carry some utility functions with me. One such utility functions is the simpler alternative to using the ugly <code>setTimeout</code>, and it gets rids of some weird use cases that comes with <code>setTimeout</code>. It's the <code>waitFor</code> utility function:</p>\n<pre><code class=\"language-js\"><span class=\"hljs-comment\">/**\n * @param {number} time Time to wait for in milliseconds\n */</span>\n<span class=\"hljs-keyword\">function</span> wait<span class=\"hljs-constructor\">For(<span class=\"hljs-params\">time</span>)</span> {\n  return <span class=\"hljs-keyword\">new</span> <span class=\"hljs-constructor\">Promise((<span class=\"hljs-params\">resolve</span>)</span> =&gt; set<span class=\"hljs-constructor\">Timeout(<span class=\"hljs-params\">resolve</span>, <span class=\"hljs-params\">time</span>)</span>);\n}\n</code></pre>\n<p>I use it simply as:</p>\n<pre><code class=\"language-js\"><span class=\"hljs-keyword\">do</span><span class=\"hljs-constructor\">Task1()</span>;\n\nawait wait<span class=\"hljs-constructor\">For(200)</span>;\n\n<span class=\"hljs-keyword\">do</span><span class=\"hljs-constructor\">Task2()</span>;\n\nawait wait<span class=\"hljs-constructor\">For(200)</span>;\n\n<span class=\"hljs-keyword\">do</span><span class=\"hljs-constructor\">Task3()</span>;\n</code></pre>\n<p>I can use it directly in modules with top level await like this:</p>\n<pre><code class=\"language-js\"><span class=\"hljs-keyword\">import</span> { waitFor } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'../utils.js'</span>;\n\n<span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-number\">1</span>);\n\n<span class=\"hljs-comment\">// Wait for 200ms</span>\n<span class=\"hljs-keyword\">await</span> waitFor(<span class=\"hljs-number\">200</span>);\n\n<span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-number\">2</span>);\n</code></pre>\n<p>I have written a blog post about this utility function too. <a href=\"https://puruvj.dev/blog/flatten-settimeout\" target=\"_blank\" rel=\"noopener\">Check it out here</a></p>\n<h2 id=\"Dependency-fallbacks\"><a class=\"heading-link\" href=\"blog/top-level-await#Dependency-fallbacks\">#</a>Dependency fallbacks</h2>\n<p>Let's say you're using your own remote server for importing Modules directly. You have come up with some superb optimization algorithms to make those imports from remote server even faster than locally bundled imports, and are willing to rely more on that server.</p>\n<p>But it's <strong>your</strong> server. You have to maintain it. 24/7!! What if it goes down? It would be a huge bummer then, wouldn't it?</p>\n<p>So you come with a clever solution: Import from your own server, but if it fails, import from <mark>unpkg</mark>. Seems smart. So you write this code:</p>\n<pre><code class=\"language-js\"><span class=\"hljs-keyword\">try</span> {\n  <span class=\"hljs-keyword\">import</span> jquery <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'https://my-server.com/api/jquery.js'</span>;\n} <span class=\"hljs-keyword\">catch</span> {\n  <span class=\"hljs-keyword\">import</span> jquery <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'https://unpkg.com/jquery@3.3.1/dist/jquery.js'</span>;\n}\n\n<span class=\"hljs-keyword\">const</span> $ = jquery.<span class=\"hljs-keyword\">default</span>;\n</code></pre>\n<p>Ahem! One catch here. This code is invalid. You can't use <code>import package from \"somewhere\"</code> inside any block. It has to be used in the top level only (This seems like the inverse problem of Top Level Await, isn't it <img class=\"emoji\" draggable=\"false\" alt=\"🤔\" src=\"https://twemoji.maxcdn.com/v/13.0.1/svg/1f914.svg\">).</p>\n<p>Luckily, we can use the dynamic <code>import</code> statement, which can be used anywhere.</p>\n<p>So our new code becomes.</p>\n<pre><code class=\"language-js\"><span class=\"hljs-keyword\">let</span> jquery;\n\n<span class=\"hljs-keyword\">try</span> {\n  jquery = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-keyword\">import</span>(<span class=\"hljs-string\">'https://my-server.com/api/jquery.js'</span>);\n} <span class=\"hljs-keyword\">catch</span> {\n  jquery = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-keyword\">import</span>(<span class=\"hljs-string\">'https://unpkg.com/jquery@3.3.1/dist/jquery.js'</span>);\n}\n\n<span class=\"hljs-keyword\">const</span> $ = jquery.<span class=\"hljs-keyword\">default</span>;\n</code></pre>\n<p>That's it! See, we used await without any async function wrapping it. It's on the top-most level. The code will wait for the <code>import</code> in the <code>try</code> block to resolve, then if it fails, will go fetch from <code>unpkg</code>, and waiting while it happens, but not stopping the execution altogether.</p>\n<h2 id=\"Internationalization-(i18n)\"><a class=\"heading-link\" href=\"blog/top-level-await#Internationalization-(i18n)\">#</a>Internationalization (i18n)</h2>\n<blockquote>\n<p>Had to search Google for the spelling of this word <img class=\"emoji\" draggable=\"false\" alt=\"😅\" src=\"https://twemoji.maxcdn.com/v/13.0.1/svg/1f605.svg\"></p>\n</blockquote>\n<p>Say you have some JS files in which you're storing common strings for different languages.</p>\n<p>Now you wish to access those strings right on top, without any other wrapper or function. You can do it simply like this:</p>\n<pre><code class=\"language-js\"><span class=\"hljs-keyword\">const</span> strings = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-keyword\">import</span>(<span class=\"hljs-string\">`../i18n/<span class=\"hljs-subst\">${navigator.language}</span>`</span>);\n\nparagraph.innerHTML = strings.paraGraph;\n</code></pre>\n<p>See how simple it is?</p>\n<p>And most bundlers like Webpack/Rollup will recognize that you're trying to fetch some files from the <code>../i18n</code> folder, so they'll just create separate, individual bundles of the files in the <code>../i18n</code> folder, and you can import the right, optimized bundle.</p>\n<blockquote>\n<p>This has traditionally been done with JSON files and <code>fetch</code>ing them, but these dynamic imports open up new possibilities</p>\n</blockquote>\n<h2 id=\"Resource-initialization\"><a class=\"heading-link\" href=\"blog/top-level-await#Resource-initialization\">#</a>Resource initialization</h2>\n<p>Let's consider a backend-related example for this. Say you have a Database implementation with lots of initialization code. Well, you'd need to initialize your database someway, and most of these databases take some amount of time, so they're always callback or promise based. Let's assume, in our case, the database instance is promise based (You can convert callback based functions to promises in NodeJS too, using <code>require('util').promisify</code>).</p>\n<p>So you initialize it:</p>\n<pre><code class=\"language-js\">import { dbInstance } from '../db';\n<span class=\"hljs-built_in\">\nconst </span>connection = await dbInstance();\n\n// Now we can simply pass the database<span class=\"hljs-built_in\"> instance </span>to the function below<span class=\"hljs-built_in\">\nconst </span>userData = await getUserData(connection);\n</code></pre>\n<p>See how simple and idiomatic it is?</p>\n<h1 id=\"Conclusion\"><a class=\"heading-link\" href=\"blog/top-level-await#Conclusion\">#</a>Conclusion</h1>\n<p>Top Level Await is an awesome addition to JavaScript, and is here to stay. Heck, even Darth Vader agrees</p>\n<p><img src=\"\" alt=\"\" class=\"feature-image\" style=\"display: none;\"></p><div class=\"picture-container\">\n  <div class=\"gif-vid-container\">\n    <video autoplay=\"\" loop=\"\" muted=\"\" playsinline=\"\">\n      <source src=\"/media/top-level-await-force-strong-darth-vader/vidgif.mp4\" type=\"video/mp4\">\n      Your browser doesn't support HTML5 video playback. <a href=\"/media/top-level-await-force-strong-darth-vader.gif\" target=\"_blank\" rel=\"noopener\">See the gif here</a>\n    </video>\n  </div>\n  </div><p></p>\n<p>Signing off! <img class=\"emoji\" draggable=\"false\" alt=\"😁\" src=\"https://twemoji.maxcdn.com/v/13.0.1/svg/1f601.svg\"></p>\n","id":"top-level-await","reading_time":4.7825}